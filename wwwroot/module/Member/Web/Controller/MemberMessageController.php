<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use ModStart\App\Web\Layout\WebPage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Field\AbstractField; use ModStart\Grid\Displayer\ItemOperate; use ModStart\Grid\Grid; use ModStart\Grid\GridFilter; use ModStart\ModStart; use ModStart\Module\ModuleBaseController; use ModStart\Repository\Filter\RepositoryFilter; use ModStart\Widget\Box; use ModStart\Widget\TextAction; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; use Module\Member\Type\MemberMessageStatus; class MemberMessageController extends ModuleBaseController implements MemberLoginCheck { private $api; public function __construct() { $this->api = app(\Module\Member\Api\Controller\MemberMessageController::class); } public function index(WebPage $ZcuyS) { goto FrFck; aKuCy: $fK3QO->batchOperatePrepend('<button class="btn" data-batch-item-read><i class="iconfont icon-checked"></i> 设为已读</button>
                    <button class="btn" data-batch-read-all><i class="iconfont icon-checked"></i> 全部已读</button>'); goto c8VGi; ZcbCW: $fK3QO->hookItemOperateRendering(function (ItemOperate $MdW0B) { $MdW0B->getField()->width(150); if ($MdW0B->item()->status === MemberMessageStatus::UNREAD) { $MdW0B->prepend(TextAction::primary('设为已读', 'data-item-read')); } }); goto aKuCy; k2ynG: list($vvDaY, $kdXNx) = $this->viewPaths('member.frame'); goto HsGDk; SweSs: ModStart::scriptFile('module/Member/Web/Controller/memberMessage.js'); goto k2ynG; c8VGi: $fK3QO->disableCUD()->canDelete(true)->canBatchDelete(true)->urlDelete(action('\\' . __CLASS__ . '@delete')); goto S31pz; HsGDk: return $ZcuyS->pageTitle('消息中心')->view($vvDaY)->body(new Box($fK3QO, '消息中心')); goto ulRVN; S31pz: if (Request::isPost()) { return $fK3QO->request(); } goto SweSs; FrFck: $fK3QO = Grid::make('member_message', function (Grid $fK3QO) { $fK3QO->datetime('created_at', '时间'); $fK3QO->richHtml('content', '内容')->hookRendering(function (AbstractField $sfBE1, $KdsT8, $D01Cg) { return "<div style='word-break:break-all;'>{$KdsT8->content}</div>"; })->listable(true)->server(modstart_web_url('member_data/ueditor')); $fK3QO->type('status', '状态')->type(MemberMessageStatus::class)->width(80); $fK3QO->repositoryFilter(function (RepositoryFilter $P2EU9) { $P2EU9->where(array('userId' => MemberUser::id())); }); $fK3QO->gridFilter(function (GridFilter $P2EU9) { $P2EU9->eq('status', '状态')->radio(MemberMessageStatus::class); }); }); goto ZcbCW; ulRVN: } public function delete() { return Response::sendFromGenerate($this->api->delete()); } public function read() { return Response::sendFromGenerate($this->api->read()); } public function readAll() { return Response::sendFromGenerate($this->api->readAll()); } }