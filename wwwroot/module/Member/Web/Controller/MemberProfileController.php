<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\View; use ModStart\App\Web\Layout\WebConfigBuilder; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Form\Form; use ModStart\Module\ModuleBaseController; use Module\Member\Auth\MemberUser; use Module\Member\Config\MemberOauth; use Module\Member\Support\MemberLoginCheck; use Module\Member\Util\MemberUtil; class MemberProfileController extends ModuleBaseController implements MemberLoginCheck { private $api; private $viewMemberFrame; public function __construct() { goto Pjq9M; Pjq9M: list($this->viewMemberFrame, $nRAaS) = $this->viewPaths('member.frame'); goto nmNeE; Ko_TG: $this->api = app(\Module\Member\Api\Controller\MemberProfileController::class); goto N2JyR; nmNeE: View::share('_viewMemberFrame', $this->viewMemberFrame); goto Ko_TG; N2JyR: } public function password(WebConfigBuilder $bhaAK) { goto HxNs_; w9YiA: $bhaAK->page()->view($this->viewMemberFrame); goto gRzkU; HxNs_: $qe8fj = MemberUser::get(); goto Xg3Rp; wY27A: $bhaAK->password('passwordNew', '新密码')->rules('required')->styleFormField('max-width:10rem;'); goto viGfh; viGfh: $bhaAK->password('passwordRepeat', '重复密码')->rules('required')->styleFormField('max-width:10rem;'); goto NpC98; gRzkU: if (empty($qe8fj['password'])) { $bhaAK->custom('tips', '')->hookRendering(function (AbstractField $sfBE1, $KdsT8, $D01Cg) { return AutoRenderedFieldValue::make('<div class="ub-alert ub-alert-warning"><i class="iconfont icon-warning"></i> 您还没有设定密码，请设定新密码</div>'); }); } else { $bhaAK->password('passwordOld', '旧密码')->required()->styleFormField('max-width:10rem;'); } goto wY27A; NpC98: return $bhaAK->perform(null, function (Form $mUGak) { return $this->api->password(); }); goto s3t00; Xg3Rp: $bhaAK->pageTitle('修改密码'); goto w9YiA; s3t00: } public function avatar() { if (Request::isPost()) { return Response::jsonFromGenerate($this->api->avatar()); } return $this->view('memberProfile.avatar', array('pageTitle' => '修改头像')); } public function captcha() { return $this->api->captchaRaw(); } public function bind() { return Response::redirect(modstart_web_url('member_profile/email')); } public function security() { return Response::redirect(modstart_web_url('member_profile/password')); } public function profile() { return Response::redirect(modstart_web_url('member_profile/avatar')); } public function oauth($nKLrL) { goto vmvr5; P15ES: BizException::throwsIfEmpty('授权登录不存在', $Cdaf0); goto pcRyW; pcRyW: $viF1V = MemberUtil::getOauth(MemberUser::id(), $Cdaf0->name()); goto DvZY6; DvZY6: $ffx88 = array('pageTitle' => $Cdaf0->title(), 'oauth' => $Cdaf0, 'oauthRecord' => $viF1V); goto N0am9; vmvr5: $Cdaf0 = MemberOauth::getOrFail($nKLrL); goto P15ES; N0am9: return $this->view('memberProfile.oauth', $ffx88); goto Y1Hvk; Y1Hvk: } public function email() { if (Request::isPost()) { return Response::jsonFromGenerate($this->api->email()); } return $this->view('memberProfile.email', array('pageTitle' => '修改邮箱')); } public function emailVerify() { return Response::sendFromGenerate($this->api->emailVerify()); } public function phone() { if (Request::isPost()) { return Response::jsonFromGenerate($this->api->phone()); } return $this->view('memberProfile.phone', array('pageTitle' => '修改手机')); } public function phoneVerify() { return Response::sendFromGenerate($this->api->phoneVerify()); } }