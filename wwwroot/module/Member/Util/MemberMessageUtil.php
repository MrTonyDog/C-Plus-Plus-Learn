<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\View; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use Module\Member\Type\MemberMessageStatus; class MemberMessageUtil { public static function getUnreadMessageCount($tGdiX) { return ModelUtil::count('member_message', array('userId' => $tGdiX, 'status' => MemberMessageStatus::UNREAD)); } public static function setMemberMessageRead($tGdiX, $JBiwJ = array()) { if (empty($JBiwJ)) { return; } ModelUtil::model('member_message')->where(array('userId' => $tGdiX))->whereIn('id', $JBiwJ)->update(array('status' => MemberMessageStatus::READ)); } public function setMemberMessageReadAll($tGdiX) { ModelUtil::model('member_message')->where(array('userId' => $tGdiX))->update(array('status' => MemberMessageStatus::READ)); } public static function paginate($tGdiX, $ZcuyS, $iy20Z, $HxhmW = array()) { goto PgJ7I; YGM5K: $LdZT6 = array(); goto HYQtc; PgJ7I: $HxhmW['where']['userId'] = $tGdiX; goto G25YQ; HYQtc: foreach ($wN_YM['records'] as $Nfq8P) { goto cck90; cck90: $KdsT8 = array(); goto tK1VH; tK1VH: $KdsT8['id'] = $Nfq8P['id']; goto W8LLa; U0mQN: $KdsT8['content'] = $Nfq8P['content']; goto vdDim; W8LLa: $KdsT8['status'] = $Nfq8P['status']; goto C9rQb; KCWxj: $LdZT6[] = $KdsT8; goto r4qJC; vdDim: $KdsT8['createTime'] = $Nfq8P['created_at']; goto KCWxj; C9rQb: $KdsT8['fromId'] = $Nfq8P['fromId']; goto U0mQN; r4qJC: } goto BLCGJ; G25YQ: $wN_YM = ModelUtil::paginate('member_message', $ZcuyS, $iy20Z, $HxhmW); goto YGM5K; BLCGJ: return array('records' => $LdZT6, 'total' => $wN_YM['total']); goto IXWHr; IXWHr: } public static function delete($tGdiX, $JBiwJ = array()) { goto TuMOy; WHyIT: if (!is_array($JBiwJ)) { $JBiwJ = array($JBiwJ); } goto AXqjb; AXqjb: ModelUtil::model('member_message')->whereIn('id', $JBiwJ)->where(array('userId' => $tGdiX))->delete(); goto Yh3XG; TuMOy: if (empty($JBiwJ)) { return; } goto WHyIT; Yh3XG: } public static function update($tGdiX, $JBiwJ = array(), $ZagfX = array()) { goto Rprrp; cgS9v: if (!is_array($JBiwJ)) { $JBiwJ = array($JBiwJ); } goto AI_OP; Rprrp: if (empty($JBiwJ) || empty($ZagfX)) { return; } goto cgS9v; AI_OP: ModelUtil::model('member_message')->whereIn('id', $JBiwJ)->where(array('userId' => $tGdiX))->update($ZagfX); goto Dk3N9; Dk3N9: } public static function updateRead($tGdiX, $JBiwJ = array()) { self::update($tGdiX, $JBiwJ, array('status' => MemberMessageStatus::READ)); } public static function updateReadAll($tGdiX) { ModelUtil::model('member_message')->where(array('userId' => $tGdiX))->update(array('status' => MemberMessageStatus::READ)); } public static function send($tGdiX, $HvAUu, $uapz3 = 0) { ModelUtil::insert('member_message', array('userId' => $tGdiX, 'fromId' => $uapz3, 'status' => MemberMessageStatus::UNREAD, 'content' => $HvAUu)); return Response::generate(0, null); } public static function sendTemplate($H7GUl, $RJldp, $hoD52 = array(), $ii4O3 = 0, $VLCiR = null) { goto X2Q2V; AAaqY: self::send($H7GUl, $vFL2k, $ii4O3); goto Kdj61; X2Q2V: $k2wFB = modstart_config()->getWithEnv('siteTemplate', 'default'); goto r7VyQ; Fxb35: if (!view()->exists($vvDaY)) { $vvDaY = 'theme.default.message.' . $RJldp; if (!view()->exists($vvDaY)) { if ($VLCiR) { $vvDaY = 'module::' . $VLCiR . '.View.' . $k2wFB . '.message.' . $RJldp; if (!view()->exists($vvDaY)) { $vvDaY = 'module::' . $VLCiR . '.View.default.message.' . $RJldp; } } else { $vvDaY = 'module::Member.View.' . $k2wFB . '.message.' . $RJldp; if (!view()->exists($vvDaY)) { $vvDaY = 'module::Member.View.default.message.' . $RJldp; } } } } goto wK04e; r7VyQ: $vvDaY = 'theme.' . $k2wFB . '.message.' . $RJldp; goto Fxb35; wK04e: if (!view()->exists($vvDaY)) { throw new \Exception('message view not found : ' . $vvDaY); } goto svc2N; svc2N: $vFL2k = View::make($vvDaY, $hoD52)->render(); goto AAaqY; Kdj61: } public static function sendTemplateFromView($vvDaY, $ffx88, $H7GUl, $ii4O3 = 0) { goto X3Lzg; S8ske: $vFL2k = View::make($vvDaY, $ffx88)->render(); goto ZKp7C; X3Lzg: if (!view()->exists($vvDaY)) { throw new \Exception('message view not found : ' . $vvDaY); } goto S8ske; ZKp7C: self::send($H7GUl, $vFL2k, $ii4O3); goto oh549; oh549: } }