<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Tecmz\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://www.tecmz.com'; private static function baseRequest($A9IXn, $hRWBB = array(), $Vhd2R = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $A9IXn, $hRWBB, array('header' => array('api-token' => $Vhd2R, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto tNO0r; NVYxN: return $mW7Vi['data']; goto VNURC; KZTCZ: BizException::throwsIfResponseError($mW7Vi); goto NVYxN; tNO0r: $mW7Vi = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto KZTCZ; VNURC: } public static function downloadPackage($Vhd2R, $R6xGd, $E291w, $HWfbK) { goto l5a78; vBvR9: BizException::throwsIfResponseError($mW7Vi); goto GPXaD; l5a78: $mW7Vi = self::baseRequest('/api/app/download_package', array('app' => $R6xGd, 'fromVersion' => $E291w, 'toVersion' => $HWfbK), $Vhd2R); goto vBvR9; ZibWC: return Response::generateSuccessData(array('diffContentFile' => $zYgkK, 'package' => $eIkLN, 'packageSize' => filesize($eIkLN))); goto jPcqJ; unt37: $M0XMX = $mW7Vi['data']['diffContent']; goto e_kY0; h4N0L: BizException::throwsIf('文件MD5校验失败', md5_file($eIkLN) != $ltbk8); goto uR47U; Lz6aN: $ltbk8 = $mW7Vi['data']['packageMd5']; goto unt37; KH841: $eIkLN = FileUtil::generateLocalTempPath('zip'); goto S0Hq_; S0Hq_: file_put_contents($eIkLN, $hRWBB); goto h4N0L; Py3t0: file_put_contents($zYgkK, $M0XMX); goto ZibWC; jRK4i: BizException::throwsIfEmpty('安装包获取失败', $hRWBB); goto KH841; uR47U: $zYgkK = FileUtil::generateLocalTempPath('json'); goto Py3t0; GPXaD: $vgCwG = $mW7Vi['data']['package']; goto Lz6aN; e_kY0: $hRWBB = CurlUtil::getRaw($vgCwG); goto jRK4i; jPcqJ: } public static function upgradePackage($vgCwG, $zYgkK) { goto kPw5d; xH_wh: if (!empty($M0XMX['update'])) { goto LLuEh; LLuEh: $Lo9Xy[] = '修改文件：'; goto YceZj; YceZj: foreach ($M0XMX['update'] as $JJGcw) { goto B_XCR; B_XCR: $HvAUu = $Er_Mh->getFileContent($JJGcw); goto VXSHc; XUYIX: $Lo9Xy[] = "> {$JJGcw}"; goto acJTt; VXSHc: FileUtil::write(base_path($JJGcw), $HvAUu); goto XUYIX; acJTt: } goto Dwia5; Dwia5: $Lo9Xy[] = ''; goto MiZ5Y; MiZ5Y: } goto MQWED; qpkPP: $Er_Mh = new Zipper(); goto fl2Eb; pOOrA: FileUtil::safeCleanLocalTemp($vgCwG); goto ndm_3; ndm_3: FileUtil::safeCleanLocalTemp($zYgkK); goto IC6CD; Kh22F: ModStart::clearCache(); goto vGVDH; pcht7: $mvcus = Artisan::call('modstart:module-install-all'); goto VaNH0; IC6CD: return Response::generateSuccessData(array('logs' => $Lo9Xy)); goto r4JgX; oTnIm: BizException::throwsIf('diffContent为空', empty($M0XMX)); goto qpkPP; vGVDH: $mvcus = Artisan::call('migrate'); goto jSXEi; VpPB8: $M0XMX = @json_decode(file_get_contents($zYgkK), true); goto oTnIm; MQWED: if (!empty($M0XMX['delete'])) { goto bPTer; bPTer: $Lo9Xy[] = '删除文件：'; goto gHJcK; KH2Jb: $Lo9Xy[] = ''; goto eyhZB; gHJcK: foreach ($M0XMX['delete'] as $JJGcw) { if (file_exists($kbmb0 = base_path($JJGcw))) { @unlink($kbmb0); $Lo9Xy[] = "> {$JJGcw}"; } } goto KH2Jb; eyhZB: } goto mnXvX; mnXvX: $Er_Mh->close(); goto Kh22F; VaNH0: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $mvcus); goto pOOrA; kPw5d: BizException::throwsIf('package不存在', !file_exists($vgCwG)); goto vLIM8; fl2Eb: $Er_Mh->make($vgCwG); goto YWCbl; SAc07: if (!empty($M0XMX['add'])) { goto fP5qC; NTBhZ: foreach ($M0XMX['add'] as $JJGcw) { goto yFlPc; TTw1X: FileUtil::write(base_path($JJGcw), $HvAUu); goto hSCqF; hSCqF: $Lo9Xy[] = "> {$JJGcw}"; goto Z2VeO; yFlPc: $HvAUu = $Er_Mh->getFileContent($JJGcw); goto TTw1X; Z2VeO: } goto EwQ3D; fP5qC: $Lo9Xy[] = '新增文件：'; goto NTBhZ; EwQ3D: $Lo9Xy[] = ''; goto onSrD; onSrD: } goto xH_wh; jSXEi: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $mvcus); goto pcht7; YWCbl: $Lo9Xy = array(); goto SAc07; vLIM8: BizException::throwsIf('diffContentFile不存在', !file_exists($zYgkK)); goto VpPB8; r4JgX: } }