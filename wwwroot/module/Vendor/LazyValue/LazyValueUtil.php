<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\LazyValue; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use Module\Vendor\Cache\CacheUtil; class LazyValueUtil { public static function hash($T_BMM, $KEWDy) { return CacheUtil::rememberForever("LazyValue.{$T_BMM}", function () use($KEWDy) { return md5(serialize($KEWDy())); }); } public static function notifyChange($T_BMM) { CacheUtil::forget("LazyValue.{$T_BMM}"); } public static function status(&$Xiug2) { foreach ($Xiug2 as $aEiYS) { if (null === $aEiYS) { return 'running'; } } return 'finish'; } public static function generateResponseWithStatus($Xiug2) { return Response::generate(0, 'ok', array('status' => LazyValueUtil::status($Xiug2), 'value' => $Xiug2)); } public static function get($T_BMM, $HAqS9, $pES2B, $M0XPu = 86400) { goto Bcn54; qGJOC: return @json_decode($pecGj['value'], true); goto HMGqJ; m10Sy: $pecGj = ModelUtil::get('lazy_value', $qHdz_); goto k31Od; ANvjN: if ($pecGj['expire'] < time()) { ModelUtil::update('lazy_value', $qHdz_, array('expire' => time() + $pES2B, 'lifeExpire' => time() + $M0XPu, 'cacheSeconds' => $pES2B)); LazyValueJob::createRefresh($T_BMM, $HAqS9, $pES2B); } goto qGJOC; k31Od: if (empty($pecGj)) { goto RTQ90; RTQ90: ModelUtil::insert('lazy_value', array('key' => $T_BMM, 'param' => json_encode($HAqS9), 'expire' => time() + $pES2B, 'lifeExpire' => time() + $M0XPu, 'cacheSeconds' => $pES2B, 'value' => null)); goto vxS3i; w9aEP: return null; goto xs6WM; vxS3i: LazyValueJob::create($T_BMM, $HAqS9, $pES2B); goto w9aEP; xs6WM: } goto ANvjN; Bcn54: $qHdz_ = array('key' => $T_BMM, 'param' => json_encode($HAqS9)); goto m10Sy; HMGqJ: } public static function watch() { goto qC1Yy; hQSuO: $Ew4t8 = ModelUtil::model('lazy_value')->where('expire', '<', time())->get(array('key', 'param', 'cacheSeconds')); goto Dptzv; Dptzv: foreach ($Ew4t8 as $P1cLT) { LazyValueJob::createRefresh($P1cLT->key, @json_decode($P1cLT->param, true), $P1cLT->cacheSeconds); } goto wMb7J; qC1Yy: ModelUtil::model('lazy_value')->where('lifeExpire', '<', time())->delete(); goto hQSuO; wMb7J: } }