<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use Illuminate\Support\Facades\Cache; use Illuminate\Support\Str; use Intervention\Image\Facades\Image; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\EncodeUtil; use ModStart\Data\DataManager; use ModStart\Data\Event\DataFileUploadedEvent; use Module\Member\Type\MemberMessageStatus; use Module\Member\Type\MemberStatus; class MemberUtil { public static function total() { return Cache::remember('MemberUserTotal', 60, function () { return ModelUtil::count('member_user'); }); } public static function get($DRfwW) { return ModelUtil::get('member_user', array('id' => $DRfwW)); } public static function processDefault(&$qe8fj) { goto nYjUT; Bsz_F: if (empty($qe8fj['nickname'])) { $qe8fj['nickname'] = $qe8fj['username']; } goto zG27y; eBAu6: if (empty($qe8fj['avatarMedium'])) { $qe8fj['avatarMedium'] = AssetsUtil::fixFull('asset/image/avatar.png', false); } goto TS5na; TS5na: if (empty($qe8fj['avatarBig'])) { $qe8fj['avatarBig'] = AssetsUtil::fixFull('asset/image/avatar.png', false); } goto uUT2V; nYjUT: if (empty($qe8fj)) { return; } goto Bsz_F; zG27y: if (empty($qe8fj['avatar'])) { $qe8fj['avatar'] = AssetsUtil::fixFull('asset/image/avatar.png', false); } goto eBAu6; uUT2V: } public static function getBasic($DRfwW, $ImCJ8 = null) { goto gqLji; PAVxz: if (empty($KdsT8)) { return null; } goto HmtLn; G71vU: $KdsT8['avatar'] = AssetsUtil::fixFullOrDefault($KdsT8['avatar'], 'asset/image/avatar.png'); goto F7BZH; gqLji: if (null === $ImCJ8) { $ImCJ8 = array('id', 'username', 'avatar', 'created_at', 'signature', 'nickname'); } goto qAd_m; HmtLn: if (empty($KdsT8['nickname'])) { $KdsT8['nickname'] = $KdsT8['username']; } goto G71vU; F7BZH: $FKDin = array(); goto ydm69; ydm69: foreach ($ImCJ8 as $teQaj) { if (isset($KdsT8[$teQaj])) { $FKDin[$teQaj] = $KdsT8[$teQaj]; } else { $FKDin[$teQaj] = null; } } goto VkprE; VkprE: return $FKDin; goto nUET9; qAd_m: $KdsT8 = self::get($DRfwW); goto PAVxz; nUET9: } public static function listViewName($JBiwJ) { goto wYeYG; wYeYG: $nChni = array(); goto r23za; r23za: $RIkMY = ModelUtil::allIn('member_user', 'id', $JBiwJ); goto TqcuW; TqcuW: foreach ($RIkMY as $qe8fj) { $nChni[] = self::viewName($qe8fj); } goto lPR5i; lPR5i: return $nChni; goto kld1M; kld1M: } public static function listUsers($JBiwJ) { return ModelUtil::allIn('member_user', 'id', $JBiwJ); } public static function convertOneToBasic($qe8fj) { return array('id' => $qe8fj['id'], 'username' => $qe8fj['username'], 'nickname' => empty($qe8fj['nickname']) ? $qe8fj['username'] : $qe8fj['nickname'], 'created_at' => $qe8fj['created_at'], 'signature' => isset($qe8fj['signature']) ? $qe8fj['signature'] : null, 'avatar' => AssetsUtil::fixFullOrDefault($qe8fj['avatar'], 'asset/image/avatar.png')); } public static function convertToBasic($RIkMY) { return array_map(function ($KdsT8) { return array('id' => $KdsT8['id'], 'username' => $KdsT8['username'], 'nickname' => empty($KdsT8['nickname']) ? $KdsT8['username'] : $KdsT8['nickname'], 'created_at' => $KdsT8['created_at'], 'signature' => isset($KdsT8['signature']) ? $KdsT8['signature'] : null, 'avatar' => AssetsUtil::fixFullOrDefault($KdsT8['avatar'], 'asset/image/avatar.png')); }, $RIkMY); } public static function listUsersBasic($JBiwJ) { return self::convertToBasic(self::listUsers($JBiwJ)); } public static function getViewName($DRfwW) { return self::viewName(self::get($DRfwW)); } public static function viewName($qe8fj) { goto FCijD; C7pBa: return "ID-{$qe8fj['id']}"; goto b5jpK; FCijD: if (empty($qe8fj)) { return '-'; } goto sEDOc; m41Nm: if (!empty($qe8fj['username'])) { return $qe8fj['username']; } goto C7pBa; sEDOc: if (!empty($qe8fj['nickname'])) { return $qe8fj['nickname']; } goto m41Nm; b5jpK: } public static function update($DRfwW, $hRWBB) { return ModelUtil::update('member_user', array('id' => $DRfwW), $hRWBB); } public static function updateBasicWithUniqueCheck($DRfwW, $hRWBB) { goto r07MQ; r07MQ: if (empty($hRWBB)) { return Response::generate(0, 'ok'); } goto bjiLD; bjiLD: foreach (array('username' => '用户名', 'phone' => '手机', 'email' => '邮箱') as $sfBE1 => $E9NYG) { if (isset($hRWBB[$sfBE1])) { goto niQDH; jVapG: if (count($pecGj) == 1) { if ($pecGj[0]['id'] != $DRfwW) { return Response::generate(-1, $E9NYG . '重复'); } } goto fzuxu; niQDH: $pecGj = ModelUtil::all('member_user', array($sfBE1 => $hRWBB[$sfBE1])); goto auvln; auvln: if (count($pecGj) > 1) { return Response::generate(-1, $E9NYG . '重复'); } goto jVapG; fzuxu: } } goto ww1gT; ww1gT: self::update($DRfwW, $hRWBB); goto qOGmW; qOGmW: return Response::generate(0, 'ok'); goto tIb2I; tIb2I: } public static function login($W03l4 = '', $dEdul = '', $plRSP = '', $cF9sV = '') { goto tHUUj; kb0UF: $dEdul = trim($dEdul); goto UIr_y; UHOP1: return Response::generateSuccessData($qe8fj); goto lJJYo; fZtpu: if (!($plRSP || $dEdul || $W03l4)) { return Response::generate(-1, '所有登录字段均为空'); } goto W97Av; w6RG6: switch ($qe8fj['status']) { case MemberStatus::FORBIDDEN: return Response::generateError(-8, '登录失败:当前用户已被禁用'); } goto UHOP1; ux53k: if (empty($qe8fj)) { return Response::generate(-6, '登录失败:用户名或密码错误'); } goto H5NQe; ewCM_: $qe8fj = ModelUtil::get('member_user', $qHdz_); goto ux53k; UIr_y: $W03l4 = trim($W03l4); goto fZtpu; tHUUj: $plRSP = trim($plRSP); goto kb0UF; H5NQe: if ($qe8fj['password'] != EncodeUtil::md5WithSalt($cF9sV, $qe8fj['passwordSalt'])) { return Response::generate(-7, '登录失败:用户名或密码错误'); } goto w6RG6; PnW9Y: if ($plRSP) { if (!preg_match('/(^[\\w\\-.]+@[\\w\\-]+\\.[\\w\\-.]+$)/', $plRSP)) { return Response::generate(-3, '邮箱格式不正确'); } $qHdz_ = array('email' => $plRSP); } else { if ($dEdul) { if (!preg_match('/(^1[0-9]{10}$)/', $dEdul)) { return Response::generate(-4, '手机格式不正确'); } $qHdz_ = array('phone' => $dEdul); } else { if ($W03l4) { if (strpos($W03l4, '@') !== false) { return Response::generate(-5, '用户名格式不正确'); } $qHdz_ = array('username' => $W03l4); } } } goto ewCM_; W97Av: if (!$cF9sV) { return Response::generate(-2, '密码为空'); } goto PnW9Y; lJJYo: } public static function registerUsernameQuick($W03l4) { goto yFm0Q; gIwtk: for ($grToB = 0; $grToB < 10; $grToB++) { $mW7Vi = self::register($ftqSb, '', '', '', true); if ($mW7Vi['code']) { $ftqSb = $ftqSb . Str::random(1); } else { return $mW7Vi; } } goto bTzVa; bTzVa: return Response::generateError('注册失败'); goto L3TlT; yFm0Q: $ftqSb = $W03l4; goto gIwtk; L3TlT: } public static function register($W03l4 = '', $dEdul = '', $plRSP = '', $cF9sV = '', $ScXVa = false) { goto u2YLU; vAzXS: if ($W03l4) { goto Eflj2; if8j_: if (Str::contains($W03l4, '@')) { return Response::generate(-1, '用户名不能包含特殊字符'); } goto kyI6C; Ui6eq: if ($mW7Vi['code']) { return $mW7Vi; } goto if8j_; kyI6C: if (preg_match('/^[0-9]{11}$/', $W03l4)) { return Response::generate(-1, '用户名不能为纯数字'); } goto rYART; Eflj2: $mW7Vi = self::uniqueCheck('username', $W03l4); goto Ui6eq; rYART: } else { $W03l4 = null; } goto njbCE; aMjHN: if (!($plRSP || $dEdul || $W03l4)) { return Response::generate(-1, '所有注册字段均为空'); } goto nCJpE; Uo60Q: $iSZC1 = Str::random(16); goto uv8bG; nCJpE: if ($plRSP) { $mW7Vi = self::uniqueCheck('email', $plRSP); if ($mW7Vi['code']) { return $mW7Vi; } } else { $plRSP = null; } goto fCHoy; uv8bG: $qe8fj = ModelUtil::insert('member_user', array('status' => MemberStatus::NORMAL, 'username' => $W03l4, 'email' => $plRSP, 'phone' => $dEdul, 'password' => $ScXVa ? null : EncodeUtil::md5WithSalt($cF9sV, $iSZC1), 'passwordSalt' => $ScXVa ? null : $iSZC1)); goto ZGUdj; b44YO: $dEdul = trim($dEdul); goto hgmt0; fCHoy: if ($dEdul) { $mW7Vi = self::uniqueCheck('phone', $dEdul); if ($mW7Vi['code']) { return $mW7Vi; } } else { $dEdul = null; } goto vAzXS; njbCE: if (!$ScXVa) { if (empty($cF9sV) || strlen($cF9sV) < 6) { return Response::generate(-3, '密码不合法'); } } goto Uo60Q; ZGUdj: return Response::generate(0, 'ok', $qe8fj); goto ahi8Y; u2YLU: $plRSP = trim($plRSP); goto b44YO; hgmt0: $W03l4 = trim($W03l4); goto aMjHN; ahi8Y: } public static function uniqueCheck($nKLrL, $Xiug2, $iELaD = 0) { goto O8VX_; O8VX_: $Xiug2 = trim($Xiug2); goto Sj290; deqSV: $qe8fj = ModelUtil::get('member_user', array($nKLrL => $Xiug2)); goto affgi; affgi: if (empty($qe8fj)) { return Response::generate(0, 'ok'); } goto NIc0e; NIc0e: $GbmLd = array('username' => '用户名', 'email' => '邮箱', 'phone' => '手机号'); goto GdY0H; eab63: return Response::generate(-2, $GbmLd[$nKLrL] . '已经被占用'); goto w9fMR; GdY0H: if ($iELaD == $qe8fj['id']) { return Response::generate(0, 'ok'); } goto eab63; Sj290: switch ($nKLrL) { case 'email': if (!preg_match('/(^[\\w-.]+@[\\w-]+\\.[\\w-.]+$)/', $Xiug2)) { return Response::generate(-1, '邮箱格式不正确'); } break; case 'phone': if (!preg_match('/(^1[0-9]{10}$)/', $Xiug2)) { return Response::generate(-1, '手机格式不正确'); } break; case 'username': if (strpos($Xiug2, '@') !== false) { return Response::generate(-1, '用户名格式不正确'); } break; default: return Response::generate(-1, '未能识别的类型' . $nKLrL); } goto deqSV; w9fMR: } public static function getByUsername($W03l4) { return ModelUtil::get('member_user', array('username' => $W03l4)); } public static function getByEmail($plRSP) { return ModelUtil::get('member_user', array('email' => $plRSP)); } public static function getByPhone($dEdul) { return ModelUtil::get('member_user', array('phone' => $dEdul)); } public static function changePassword($H7GUl, $vFr2p, $fQpdS = null, $S9iGP = false) { goto TOMse; LrBO7: $qe8fj = ModelUtil::get('member_user', array('id' => $H7GUl)); goto sR4IP; C5A6k: return Response::generate(0, 'ok'); goto eb1BB; sR4IP: if (empty($qe8fj)) { return Response::generate(-1, '用户不存在'); } goto VkZsH; a2NhF: $iSZC1 = Str::random(16); goto EgnN0; VkZsH: if (empty($vFr2p)) { return Response::generate(-1, '新密码为空'); } goto d6k6D; TOMse: if (!$S9iGP && empty($fQpdS)) { return Response::generate(-1, '旧密码不能为空'); } goto LrBO7; d6k6D: if (!$S9iGP && EncodeUtil::md5WithSalt($fQpdS, $qe8fj['passwordSalt']) != $qe8fj['password']) { return Response::generate(-1, '旧密码不正确'); } goto a2NhF; EgnN0: ModelUtil::update('member_user', array('id' => $qe8fj['id']), array('passwordSalt' => $iSZC1, 'password' => EncodeUtil::md5WithSalt($vFr2p, $iSZC1))); goto C5A6k; eb1BB: } public static function setAvatar($tGdiX, $Wfmhp, $xLhgB = 'jpg') { goto QfcQx; E8jyQ: if (empty($Wfmhp)) { return Response::generate(-1, '图片数据为空'); } goto Nuzb4; RxMEl: $slA2G = DataManager::upload('image', 'U' . $tGdiX . '_AvatarBig.' . $xLhgB, $nqJIZ); goto NI8eG; SZm91: $pzFyq = (string) Image::make($Wfmhp)->resize(200, 200)->encode($xLhgB, 75); goto Aezpc; TuNW3: if ($IBdLb['code']) { DataManager::deleteById($slA2G['data']['id']); if ($slA2G['code']) { return Response::generate(-1, '头像存储失败（' . $IBdLb['msg'] . '）'); } } goto fnaMO; mDYsP: if (class_exists('ModStart\\Data\\Event\\DataFileUploadedEvent')) { DataFileUploadedEvent::forgetParam('imageCompressIgnore'); DataFileUploadedEvent::forgetParam('imageWatermarkIgnore'); } goto QHX3h; NI8eG: if ($slA2G['code']) { return Response::generate(-1, '头像存储失败（' . $slA2G['msg'] . '）'); } goto LXcly; f4G4F: if (class_exists('ModStart\\Data\\Event\\DataFileUploadedEvent')) { DataFileUploadedEvent::setParam('imageCompressIgnore', true); DataFileUploadedEvent::setParam('imageWatermarkIgnore', true); } goto RxMEl; gp251: return Response::generateSuccess(); goto N1Tu3; RcJ2d: if ($mW7Vi['code']) { goto tETwE; nVaEr: if ($slA2G['code']) { return Response::generate(-1, '头像存储失败（' . $mW7Vi['msg'] . '）'); } goto Jar0q; gaTSF: DataManager::deleteById($IBdLb['data']['id']); goto nVaEr; tETwE: DataManager::deleteById($slA2G['data']['id']); goto gaTSF; Jar0q: } goto mDYsP; xXMQr: if (empty($qe8fj)) { return Response::generate(-1, '用户不存在'); } goto E8jyQ; LXcly: $IBdLb = DataManager::upload('image', 'U' . $tGdiX . '_AvatarMiddle.' . $xLhgB, $pzFyq); goto TuNW3; Aezpc: $Pe32p = (string) Image::make($Wfmhp)->resize(50, 50)->encode($xLhgB, 75); goto f4G4F; QHX3h: self::update($qe8fj['id'], array('avatarBig' => $slA2G['data']['fullPath'], 'avatarMedium' => $IBdLb['data']['fullPath'], 'avatar' => $mW7Vi['data']['fullPath'])); goto gp251; fnaMO: $mW7Vi = DataManager::upload('image', 'U_' . $tGdiX . '_Avatar.' . $xLhgB, $Pe32p); goto RcJ2d; QfcQx: $qe8fj = self::get($tGdiX); goto xXMQr; Nuzb4: $nqJIZ = (string) Image::make($Wfmhp)->resize(400, 400)->encode($xLhgB, 75); goto SZm91; N1Tu3: } public static function findUsers($GlOVF) { goto kF0CM; VBdMo: $RIkMY = ModelUtil::model('member_user')->whereIn('id', $GlOVF)->get(); goto gLd6l; kF0CM: $xpXIR = array(); goto VBdMo; gLd6l: foreach ($RIkMY as &$OP5Vh) { $xpXIR[$OP5Vh->id] = $OP5Vh->toArray(); } goto Q42XE; Q42XE: return $xpXIR; goto TNgOb; TNgOb: } public static function mergeMemberUsers(&$LdZT6, $gusMv = 'memberUserId', $SfInv = '_memberUser') { ModelUtil::join($LdZT6, $gusMv, $SfInv, 'member_user', 'id'); } public static function mergeMemberUserBasics(&$LdZT6, $gusMv = 'memberUserId', $SfInv = '_memberUser', $ImCJ8 = null) { if (null === $ImCJ8) { $ImCJ8 = array('id', 'username', 'avatar', 'created_at', 'signature', 'nickname'); } if (is_array($LdZT6)) { ModelUtil::join($LdZT6, $gusMv, $SfInv, 'member_user', 'id'); foreach ($LdZT6 as $Zc0iK => $aEiYS) { goto QmEnp; QmEnp: $qe8fj = ArrayUtil::keepKeys($aEiYS[$SfInv], $ImCJ8); goto vxuHi; I1DYX: if (empty($qe8fj['avatar'])) { $qe8fj['avatar'] = AssetsUtil::fixFull('asset/image/avatar.png'); } else { $qe8fj['avatar'] = AssetsUtil::fixFull($qe8fj['avatar']); } goto gUQar; vxuHi: if (empty($qe8fj['nickname'])) { $qe8fj['nickname'] = $qe8fj['username']; } goto I1DYX; gUQar: $LdZT6[$Zc0iK][$SfInv] = $qe8fj; goto eW1ch; eW1ch: } } else { ModelUtil::joinItems($LdZT6, $gusMv, $SfInv, 'member_user', 'id'); foreach ($LdZT6 as $KdsT8) { goto o5Alj; qrx85: if (empty($qe8fj['avatar'])) { $qe8fj['avatar'] = AssetsUtil::fixFull('asset/image/avatar.png'); } else { $qe8fj['avatar'] = AssetsUtil::fixFull($qe8fj['avatar']); } goto e2at5; gJjvz: if (empty($qe8fj['nickname'])) { $qe8fj['nickname'] = $qe8fj['username']; } goto qrx85; o5Alj: $qe8fj = ArrayUtil::keepKeys($KdsT8->{$SfInv}, $ImCJ8); goto gJjvz; e2at5: $KdsT8->{$SfInv} = $qe8fj; goto GQfDF; GQfDF: } } } public static function insert($hRWBB) { return ModelUtil::insert('member_user', $hRWBB); } public static function getIdByOauth($LYyd5, $JVgHL) { goto nutjz; hP_d_: if (empty($avQLM)) { return 0; } goto s3pSu; nutjz: $avQLM = ModelUtil::get('member_oauth', array('type' => $LYyd5, 'openId' => $JVgHL)); goto hP_d_; s3pSu: return intval($avQLM['memberUserId']); goto lIQa1; lIQa1: } public static function getIdByOauthAndCheck($LYyd5, $JVgHL) { goto x2A3b; uNJZS: if (self::get($H7GUl)) { return $H7GUl; } goto X05f7; x2A3b: $H7GUl = self::getIdByOauth($LYyd5, $JVgHL); goto uNJZS; X05f7: MemberUtil::forgetOauth($LYyd5, $JVgHL); goto YxJxo; YxJxo: return 0; goto DDMfe; DDMfe: } public static function getOauthOpenId($H7GUl, $LYyd5) { goto SPVby; SPVby: $qHdz_ = array('memberUserId' => $H7GUl, 'type' => $LYyd5); goto tdv1U; XKcKU: if (empty($avQLM)) { return null; } goto uIyhv; tdv1U: $avQLM = ModelUtil::get('member_oauth', $qHdz_); goto XKcKU; uIyhv: return $avQLM['openId']; goto U041m; U041m: } public static function getOauth($H7GUl, $LYyd5) { $qHdz_ = array('memberUserId' => $H7GUl, 'type' => $LYyd5); return ModelUtil::get('member_oauth', $qHdz_); } public static function putOauth($H7GUl, $LYyd5, $JVgHL, $iNjgR = array()) { goto bDg00; J0fBa: $avQLM = ModelUtil::get('member_oauth', $qHdz_); goto hsjKd; bDg00: $qHdz_ = array('memberUserId' => $H7GUl, 'type' => $LYyd5); goto J0fBa; hsjKd: if (empty($avQLM)) { ModelUtil::insert('member_oauth', array_merge($qHdz_, array('openId' => $JVgHL), $iNjgR)); } else { if ($avQLM['openId'] != $JVgHL) { ModelUtil::update('member_oauth', array('id' => $avQLM['id']), array_merge(array('openId' => $JVgHL), $iNjgR)); } } goto ZpVt7; ZpVt7: } public static function forgetOauth($LYyd5, $JVgHL) { ModelUtil::delete('member_oauth', array('type' => $LYyd5, 'openId' => $JVgHL)); } public static function updateNewMessageStatus($H7GUl) { ModelUtil::update('member_user', array('id' => $H7GUl), array('newMessageCount' => ModelUtil::count('member_message', array('userId' => $H7GUl, 'status' => MemberMessageStatus::UNREAD)))); } public static function updateNewChatMsgStatus($H7GUl) { ModelUtil::update('member_user', array('id' => $H7GUl), array('newChatMsgCount' => ModelUtil::sum('member_chat', 'unreadMsgCount', array('memberUserId' => $H7GUl)))); } public static function paginate($ZcuyS, $iy20Z, $HxhmW = array()) { return ModelUtil::paginate('member_user', $ZcuyS, $iy20Z, $HxhmW); } }