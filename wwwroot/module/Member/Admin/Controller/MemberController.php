<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Auth\AdminPermission; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminConfigBuilder; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Admin\Layout\AdminDialogPage; use ModStart\Core\Assets\AssetsUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\CRUDUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\Form\Type\FormMode; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Support\Concern\HasFields; use ModStart\Widget\TextDialogRequest; use Module\Member\Config\MemberAdminList; use Module\Member\Provider\MemberAdminShowPanel\MemberAdminShowPanelProvider; use Module\Member\Type\MemberStatus; use Module\Member\Util\MemberGroupUtil; use Module\Member\Util\MemberMessageUtil; use Module\Member\Util\MemberUtil; use Module\Member\Util\MemberVipUtil; class MemberController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $bhaAK) { $bhaAK->init('member_user')->field(function ($bhaAK) { $bhaAK->id('id', 'ID'); MemberAdminList::callGridField($bhaAK); $bhaAK->display('avatar', '头像')->hookRendering(function (AbstractField $sfBE1, $KdsT8, $D01Cg) { $qmTHg = AssetsUtil::fixOrDefault($KdsT8->avatar, 'asset/image/avatar.png'); $NXHa2 = AssetsUtil::fixOrDefault($KdsT8->avatarBig, 'asset/image/avatar.png'); return AutoRenderedFieldValue::make("<a href='{$NXHa2}' class='tw-inline-block' data-image-preview>\n                        <img src='{$qmTHg}' class='tw-rounded-full tw-w-8 tw-h-8 tw-shadow'></a>"); }); $bhaAK->text('username', '用户名')->required()->ruleUnique('member_user')->hookRendering(function (AbstractField $sfBE1, $KdsT8, $D01Cg) { switch ($sfBE1->renderMode()) { case FieldRenderMode::GRID: case FieldRenderMode::DETAIL: return AutoRenderedFieldValue::make(TextDialogRequest::make('primary', htmlspecialchars($KdsT8->username), modstart_admin_url('member/show', array('_id' => $KdsT8->id)))->width('90%')->height('90%')->render()); break; } }); $bhaAK->text('password', '初始密码')->editable(false)->addable(true)->listable(false)->showable(false)->required()->defaultValue(RandomUtil::lowerString(8)); $bhaAK->text('email', '邮箱'); $bhaAK->text('phone', '手机'); $bhaAK->type('status', '状态')->type(MemberStatus::class, array(MemberStatus::NORMAL => 'success', MemberStatus::FORBIDDEN => 'danger'))->required(); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $bhaAK->radio('groupId', '分组')->options(MemberGroupUtil::mapIdTitle())->required(); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $bhaAK->radio('vipId', 'VIP')->options(MemberVipUtil::mapTitle())->required(); $bhaAK->date('vipExpire', 'VIP过期')->required(); } $bhaAK->display('created_at', '注册时间'); })->gridFilter(function (GridFilter $P2EU9) { $P2EU9->eq('id', L('ID')); $P2EU9->like('username', '用户名'); $P2EU9->like('email', '邮箱')->autoHide(true); $P2EU9->like('phone', '手机')->autoHide(true); $P2EU9->eq('status', '状态')->autoHide(true)->select(MemberStatus::class); if (ModuleManager::getModuleConfigBoolean('Member', 'groupEnable', false)) { $P2EU9->eq('groupId', '分组')->autoHide(true)->select(MemberGroupUtil::mapIdTitle()); } if (ModuleManager::getModuleConfigBoolean('Member', 'vipEnable', false)) { $P2EU9->eq('vipId', 'VIP')->autoHide(true)->select(MemberVipUtil::mapTitle()); } })->hookSaved(function (Form $mUGak) { $KdsT8 = $mUGak->item(); switch ($mUGak->mode()) { case FormMode::ADD: MemberUtil::changePassword($KdsT8->id, $KdsT8->password, null, true); break; } })->title('用户')->canDelete(false); } public function select(AdminDialogPage $ZcuyS) { goto n8Ahy; v0xlz: if (Request::isPost()) { return $fK3QO->request(); } goto Cbz2I; uDiKt: $fK3QO->canSingleSelectItem(true); goto mqANQ; n8Ahy: $fK3QO = $this->grid(); goto t2ehI; Cbz2I: return $ZcuyS->pageTitle('选择用户')->body($fK3QO); goto LegrU; t2ehI: $fK3QO->disableCUD(); goto uDiKt; mqANQ: CRUDUtil::registerGridResource($fK3QO, '\\' . __CLASS__); goto v0xlz; LegrU: } public function search() { goto UhDsq; R_rri: $LdZT6 = array_map(function ($KdsT8) { return array('value' => intval($KdsT8['id']), 'name' => htmlspecialchars(MemberUtil::viewName($KdsT8)), 'avatar' => AssetsUtil::fixOrDefault($KdsT8['avatar'], 'asset/image/avatar.png')); }, $wN_YM['records']); goto GkJdK; NI6Dq: $TN04r = $HoLMG->getTrimString('keywords'); goto Za0LY; iOYCW: $wN_YM = MemberUtil::paginate(1, 10, $HxhmW); goto R_rri; UhDsq: $HoLMG = InputPackage::buildFromInput(); goto NI6Dq; Za0LY: $HxhmW = array(); goto ey2yj; GkJdK: return Response::jsonSuccessData($LdZT6); goto s6zFz; ey2yj: $HxhmW['whereOperate'] = array('username', 'like', "%{$TN04r}%"); goto iOYCW; s6zFz: } public function resetPassword(AdminConfigBuilder $bhaAK) { goto FEqN7; OypHc: $bhaAK->useDialog(); goto ZaCEr; drRnD: $qe8fj = MemberUtil::get($DRfwW); goto XKaBN; Nh9Bf: if (Request::isPost()) { return $bhaAK->formRequest(function (Form $mUGak) use($qe8fj) { AdminPermission::demoCheck(); $hRWBB = $mUGak->dataForming(); $mW7Vi = MemberUtil::changePassword($qe8fj['id'], $hRWBB['passwordNew'], null, true); BizException::throwsIfResponseError($mW7Vi); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto LeERd; XKaBN: BizException::throwsIfEmpty('用户不存在', $qe8fj); goto OypHc; FEqN7: $DRfwW = CRUDUtil::id(); goto drRnD; ZaCEr: $bhaAK->pageTitle('重置密码'); goto In0Kf; LeERd: return $bhaAK; goto xcYbo; In0Kf: $bhaAK->text('passwordNew', '新密码')->required()->defaultValue(RandomUtil::upperString(6)); goto Nh9Bf; xcYbo: } public function sendMessage(AdminConfigBuilder $bhaAK) { goto UNUR8; MtopB: BizException::throwsIfEmpty('用户不存在', $qe8fj); goto mt8ua; UNUR8: $DRfwW = CRUDUtil::id(); goto n66jW; n66jW: $qe8fj = MemberUtil::get($DRfwW); goto MtopB; PbSL_: $bhaAK->pageTitle('发送消息'); goto tZsG0; avGl_: return $bhaAK; goto Gnyjy; TNCyy: if (Request::isPost()) { return $bhaAK->formRequest(function (Form $mUGak) use($qe8fj) { AdminPermission::demoCheck(); $hRWBB = $mUGak->dataForming(); $mW7Vi = MemberMessageUtil::send($qe8fj['id'], $hRWBB['content']); BizException::throwsIfResponseError($mW7Vi); return Response::redirect(CRUDUtil::jsDialogClose()); }); } goto avGl_; tZsG0: $bhaAK->richHtml('content', '消息内容')->required(); goto TNCyy; mt8ua: $bhaAK->useDialog(); goto PbSL_; Gnyjy: } public function show() { goto thbni; TYk9N: $xw8bV = MemberAdminShowPanelProvider::listAll(); goto WOgvW; thbni: $Nfq8P = MemberUtil::get(CRUDUtil::id()); goto TYk9N; WOgvW: return view('module::Member.View.admin.memberUser.show', array('record' => $Nfq8P, 'showPanelProviders' => $xw8bV)); goto qFg1f; qFg1f: } }