<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Input\Response; use Module\Vendor\Cache\CacheUtil; class MemberVipUtil { public static function isEnable() { return modstart_config('moduleMemberVipEnable', false); } public static function all() { return CacheUtil::rememberForever('MemberVipList', function () { return ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')); }); } public static function update($DRfwW, $hRWBB) { ModelUtil::update('member_vip_set', $DRfwW, $hRWBB); self::clearCache(); } public static function map() { return CacheUtil::rememberForever('MemberVipMap', function () { $Wseaz = array(); foreach (ModelUtil::all('member_vip_set', array(), array('*'), array('sort', 'asc')) as $KdsT8) { $Wseaz[intval($KdsT8['id'])] = $KdsT8; } return $Wseaz; }); } public static function mapTitle() { return array_build(self::map(), function ($Zc0iK, $aEiYS) { return array($Zc0iK, $aEiYS['title']); }); } public static function getMemberVipById($H7GUl, $T_BMM = null, $bw2yx = null) { $qe8fj = MemberUtil::get($H7GUl); return self::getMemberVip($qe8fj, $T_BMM, $bw2yx); } public static function getMemberVip($qe8fj, $T_BMM = null, $bw2yx = null) { goto DcG8D; Z7QIh: if (empty($ziPEg)) { return null; } goto exEEB; pR9zW: return isset($ziPEg[$T_BMM]) ? $ziPEg[$T_BMM] : $bw2yx; goto b2l3P; exEEB: if (null === $T_BMM) { return $ziPEg; } goto pR9zW; DcG8D: if (empty($qe8fj)) { $ziPEg = self::get(null); } else { if (!empty($qe8fj['vipExpire']) && strtotime($qe8fj['vipExpire']) > time()) { $ziPEg = self::get($qe8fj['vipId']); } else { $ziPEg = self::get(null); } } goto Z7QIh; b2l3P: } public static function getDefaultVip() { foreach (self::map() as $ZSIA_ => $ziPEg) { if (!empty($ziPEg['isDefault'])) { return $ziPEg; } } return null; } public static function get($ZSIA_, $T_BMM = null) { goto gDKpZ; NQkez: if (null === $T_BMM) { if (isset($Wseaz[$ZSIA_])) { return $Wseaz[$ZSIA_]; } return self::getDefaultVip(); } else { goto HhxvH; HhxvH: if (isset($Wseaz[$ZSIA_][$T_BMM])) { return $Wseaz[$ZSIA_][$T_BMM]; } goto XH9DS; XH9DS: $ziPEg = self::getDefaultVip(); goto mUoj4; mUoj4: if (isset($ziPEg[$T_BMM])) { return $ziPEg[$T_BMM]; } goto WDF2B; WDF2B: } goto IabtO; IabtO: return null; goto N3q84; gDKpZ: $Wseaz = self::map(); goto NQkez; N3q84: } public static function calcPrice($vkqJw, $WYKOF, $Bgri5) { goto KhnQ3; mDYZq: $nKLrL = null; goto dIf0j; AW4Jx: $VeEza = $muKEN ? $muKEN['vipDays'] : 0; goto i1YfC; KhnQ3: $EOfZP = self::get($vkqJw); goto AVkaP; keI0m: return Response::generate(0, 'ok', array('type' => $nKLrL, 'expire' => $P1cLT, 'price' => $gp4pl)); goto F79il; AVkaP: $oPxpf = $EOfZP ? $EOfZP['price'] : 0; goto j4wBK; Totr8: $Ue3r8 = strtotime($WYKOF) > 0 ? strtotime($WYKOF) : 0; goto DGci_; DGci_: $P1cLT = null; goto e6NO4; i1YfC: if (empty($muKEN)) { return Response::generate(-1, '数据错误'); } goto Totr8; j4wBK: $T1n9K = $EOfZP ? $EOfZP['vipDays'] : 0; goto I0QH4; e6NO4: $gp4pl = 0; goto mDYZq; VCk9B: $HvY9e = $muKEN ? $muKEN['price'] : 0; goto AW4Jx; I0QH4: $muKEN = self::get($Bgri5); goto VCk9B; dIf0j: if ($vkqJw == $Bgri5) { goto xI97S; o_jmc: $gp4pl = $muKEN['price']; goto voVzE; Lu3dt: $P1cLT = date('Y-m-d', max($Ue3r8, time()) + $muKEN['vipDays'] * 24 * 3600); goto o_jmc; xI97S: $nKLrL = '续费会员'; goto Lu3dt; voVzE: } else { if ($Ue3r8 > 0) { goto FR7lZ; UoCht: $zVRjM = max(time() + $muKEN['vipDays'] * 24 * 3600, $Ue3r8); goto ZRizP; pYBUE: $gp4pl = max(bcsub($gp4pl, $NnGS6, 2), 0.01); goto PzkJF; FR7lZ: $nKLrL = '变更会员'; goto UoCht; MHXkm: $oIK1b = $EOfZP['vipDays']; goto yY0xM; WbzoK: $oEtap = max(0, intval(($Ue3r8 - time()) / (24 * 3600))); goto MHXkm; yY0xM: $NnGS6 = $oIK1b > 0 ? $EOfZP['price'] * $oEtap / $oIK1b : 0; goto pYBUE; ZRizP: $P1cLT = date('Y-m-d', $zVRjM); goto EHbtK; EHbtK: $gp4pl = $muKEN['price'] * (($zVRjM - time()) / (24 * 3600)) / $muKEN['vipDays']; goto WbzoK; PzkJF: } else { goto VR_ce; VR_ce: $nKLrL = '新开会员'; goto t3jBu; t3jBu: $P1cLT = date('Y-m-d', time() + $muKEN['vipDays'] * 24 * 3600); goto pNETV; pNETV: $gp4pl = $muKEN['price']; goto W3Dea; W3Dea: } } goto keI0m; F79il: } public static function clearCache() { CacheUtil::forget('MemberVipList'); CacheUtil::forget('MemberVipMap'); } }