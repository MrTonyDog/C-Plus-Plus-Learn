<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\ES; use Elasticsearch\ClientBuilder; class ESBaseUtil { public static function createIndex($qNtCk, $k8iQn = 'v1') { if (!isset(static::$tableProperties[$qNtCk])) { throw new \Exception('不存在的索引'); } if (!self::client()->indices()->exists(array('index' => $qNtCk . '_' . $k8iQn))) { self::client()->indices()->create(array('index' => $qNtCk . '_' . $k8iQn, 'body' => array('settings' => array('max_result_window' => 50000), 'mappings' => array($qNtCk => array('properties' => static::$tableProperties[$qNtCk]))))); } } public static function deleteIndex($qNtCk, $k8iQn = 'v1') { if (!isset(static::$tableProperties[$qNtCk])) { throw new \Exception('不存在的索引'); } if (self::client()->indices()->exists(array('index' => $qNtCk . '_' . $k8iQn))) { self::client()->indices()->delete(array('index' => $qNtCk . '_' . $k8iQn)); } } public static function deleteAlias($qNtCk, $k8iQn = 'v1') { if (!isset(static::$tableProperties[$qNtCk])) { throw new \Exception('不存在的索引'); } if (self::client()->indices()->existsAlias(array('name' => $qNtCk))) { self::client()->indices()->deleteAlias(array('index' => $qNtCk . '_' . $k8iQn, 'name' => $qNtCk)); } } public static function putAlias($qNtCk, $k8iQn = 'v1') { if (!isset(static::$tableProperties[$qNtCk])) { throw new \Exception('不存在的索引'); } if (!self::client()->indices()->existsAlias(array('name' => $qNtCk))) { self::client()->indices()->putAlias(array('index' => $qNtCk . '_' . $k8iQn, 'name' => $qNtCk)); } } public static function stats() { return self::client()->indices()->stats(); } public static function statsIndex($D01Cg) { goto gTN3I; gTN3I: $Sv3i2 = self::client()->indices()->stats(); goto QB8T8; sK1xn: return null; goto NfgFv; QB8T8: if (!empty($Sv3i2['indices'])) { foreach ($Sv3i2['indices'] as $Zc0iK => $aEiYS) { if (preg_match("/^{$D01Cg}_v\\d+\$/", $Zc0iK)) { return $aEiYS; } } } goto sK1xn; NfgFv: } public static function client($Lz3E_ = array()) { goto M_DmR; FRyma: if (null === $bboet) { goto r6uEK; YpEnk: $bboet = ClientBuilder::create()->setHosts($p15ui)->build(); goto Bq_Fs; r6uEK: $tu0B0 = modstart_config(); goto oAJm4; oAJm4: $p15ui = array(array_merge(array('host' => $tu0B0->getWithEnv('moduleESHost'), 'port' => $tu0B0->getWithEnv('moduleESPort'), 'scheme' => 'http', 'user' => $tu0B0->getWithEnv('moduleESUser'), 'pass' => $tu0B0->getWithEnv('moduleESPass')), $Lz3E_)); goto YpEnk; Bq_Fs: } goto fm0nn; fm0nn: return $bboet; goto d5SE1; M_DmR: static $bboet = null; goto FRyma; d5SE1: } public static function save($qNtCk, $Nfq8P) { goto mz0Xd; mz0Xd: if (!isset(static::$tableProperties[$qNtCk])) { throw new \Exception('不存在的索引'); } goto kbNpn; LZ2ri: $WLLtk = self::client()->index(array('index' => $qNtCk, 'type' => $qNtCk, 'id' => $Nfq8P['id'], 'body' => $Nfq8P)); goto NYktr; kbNpn: $bboet = static::client(); goto LZ2ri; NYktr: } public static function saveBulk($qNtCk, $LdZT6) { goto WeNrd; WeNrd: if (!isset(static::$tableProperties[$qNtCk])) { throw new \Exception('不存在的索引'); } goto VPVL7; VPVL7: $gKSAy = array(); goto Lu6kW; VIcWs: $bboet = static::client(); goto pXei6; pXei6: $WLLtk = self::client()->bulk(array('index' => $qNtCk, 'type' => $qNtCk, 'body' => $gKSAy)); goto tFFT8; Lu6kW: foreach ($LdZT6 as $Nfq8P) { $gKSAy[] = array('index' => array('_index' => $qNtCk, '_id' => $Nfq8P['id'], '_type' => $qNtCk)); $gKSAy[] = $Nfq8P; } goto VIcWs; tFFT8: } }