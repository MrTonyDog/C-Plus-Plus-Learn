<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\AdminManager\Util; use App\Constant\AppConstant; use Chumper\Zipper\Zipper; use Illuminate\Support\Facades\Artisan; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Response; use ModStart\Core\Util\CurlUtil; use ModStart\Core\Util\FileUtil; use ModStart\ModStart; class UpgradeUtil { const REMOTE_BASE = 'https://modstart.com'; private static function baseRequest($A9IXn, $hRWBB = array(), $Vhd2R = null) { return CurlUtil::postJSONBody(self::REMOTE_BASE . $A9IXn, $hRWBB, array('header' => array('api-token' => $Vhd2R, 'X-Requested-With' => 'XMLHttpRequest'))); } public static function latest() { goto McTTe; McTTe: $mW7Vi = self::baseRequest('/api/app/latest', array('app' => AppConstant::APP, 'version' => AppConstant::VERSION)); goto xbZZ9; xbZZ9: BizException::throwsIfResponseError($mW7Vi); goto qno3e; qno3e: return $mW7Vi['data']; goto hIGyS; hIGyS: } public static function downloadPackage($Vhd2R, $R6xGd, $E291w, $HWfbK) { goto fjhu6; fHd2I: $zYgkK = FileUtil::generateLocalTempPath('json'); goto np23D; By2rZ: BizException::throwsIf('文件MD5校验失败', md5_file($eIkLN) != $ltbk8); goto fHd2I; nQBxO: BizException::throwsIfEmpty('安装包获取失败', $hRWBB); goto KKn0d; nprmv: $hRWBB = CurlUtil::getRaw($vgCwG); goto nQBxO; uy3eA: BizException::throwsIfResponseError($mW7Vi); goto Tf3hp; np23D: file_put_contents($zYgkK, $M0XMX); goto WM169; KKn0d: $eIkLN = FileUtil::generateLocalTempPath('zip'); goto bZJIF; fjhu6: $mW7Vi = self::baseRequest('/api/app/download_package', array('app' => $R6xGd, 'fromVersion' => $E291w, 'toVersion' => $HWfbK), $Vhd2R); goto uy3eA; qlxBs: $ltbk8 = $mW7Vi['data']['packageMd5']; goto IAY0v; WM169: return Response::generateSuccessData(array('diffContentFile' => $zYgkK, 'package' => $eIkLN, 'packageSize' => filesize($eIkLN))); goto vcqCP; Tf3hp: $vgCwG = $mW7Vi['data']['package']; goto qlxBs; IAY0v: $M0XMX = $mW7Vi['data']['diffContent']; goto nprmv; bZJIF: file_put_contents($eIkLN, $hRWBB); goto By2rZ; vcqCP: } public static function upgradePackage($vgCwG, $zYgkK) { goto iZyXg; bbM33: $Er_Mh = new Zipper(); goto I3pf6; PNW9t: $M0XMX = @json_decode(file_get_contents($zYgkK), true); goto MWa2J; e3dxG: BizException::throwsIf('调用 php artisan migrate 失败', 0 != $mvcus); goto D0h26; D0h26: $mvcus = Artisan::call('modstart:module-install-all'); goto tWT4I; skjQu: if (!empty($M0XMX['add'])) { goto AbrTU; fzWOU: foreach ($M0XMX['add'] as $JJGcw) { goto rY4BK; xFnU0: $Lo9Xy[] = "> {$JJGcw}"; goto y3oXA; Ebq0G: FileUtil::write(base_path($JJGcw), $HvAUu); goto xFnU0; rY4BK: $HvAUu = $Er_Mh->getFileContent($JJGcw); goto Ebq0G; y3oXA: } goto zUf98; AbrTU: $Lo9Xy[] = '新增文件：'; goto fzWOU; zUf98: $Lo9Xy[] = ''; goto xrZJo; xrZJo: } goto UNcL7; tWT4I: BizException::throwsIf('调用 php artisan modstart:module-install-all 失败', 0 != $mvcus); goto C27BC; imiAj: $Lo9Xy = array(); goto skjQu; GkeU2: return Response::generateSuccessData(array('logs' => $Lo9Xy)); goto oZcD3; QJU1R: if (!empty($M0XMX['delete'])) { goto SwILm; SwILm: $Lo9Xy[] = '删除文件：'; goto YjoY9; BdSKQ: $Lo9Xy[] = ''; goto MQdPK; YjoY9: foreach ($M0XMX['delete'] as $JJGcw) { if (file_exists($kbmb0 = base_path($JJGcw))) { @unlink($kbmb0); $Lo9Xy[] = "> {$JJGcw}"; } } goto BdSKQ; MQdPK: } goto xWYPC; iZyXg: BizException::throwsIf('package不存在', !file_exists($vgCwG)); goto zWq0q; UNcL7: if (!empty($M0XMX['update'])) { goto b1bJs; Q3QF5: $Lo9Xy[] = ''; goto aKStd; cTn43: foreach ($M0XMX['update'] as $JJGcw) { goto dg9bo; AnrB2: FileUtil::write(base_path($JJGcw), $HvAUu); goto kmGg4; kmGg4: $Lo9Xy[] = "> {$JJGcw}"; goto t8GVn; dg9bo: $HvAUu = $Er_Mh->getFileContent($JJGcw); goto AnrB2; t8GVn: } goto Q3QF5; b1bJs: $Lo9Xy[] = '修改文件：'; goto cTn43; aKStd: } goto QJU1R; DHJHo: FileUtil::safeCleanLocalTemp($zYgkK); goto GkeU2; K_alF: $mvcus = Artisan::call('migrate'); goto e3dxG; MWa2J: BizException::throwsIf('diffContent为空', empty($M0XMX)); goto bbM33; zWq0q: BizException::throwsIf('diffContentFile不存在', !file_exists($zYgkK)); goto PNW9t; sLJlq: ModStart::clearCache(); goto K_alF; C27BC: FileUtil::safeCleanLocalTemp($vgCwG); goto DHJHo; xWYPC: $Er_Mh->close(); goto sLJlq; I3pf6: $Er_Mh->make($vgCwG); goto imiAj; oZcD3: } }