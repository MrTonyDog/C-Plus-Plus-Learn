<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Nav\Admin\Controller; use Illuminate\Routing\Controller; use ModStart\Admin\Concern\HasAdminQuickCRUD; use ModStart\Admin\Layout\AdminCRUDBuilder; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Type\TypeUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Field\Type\FieldRenderMode; use ModStart\Form\Form; use ModStart\Grid\GridFilter; use ModStart\ModStart; use ModStart\Repository\Filter\ScopeFilter; use ModStart\Support\Concern\HasFields; use Module\Nav\Type\NavOpenType; use Module\Nav\Type\NavPosition; use Module\Nav\Util\NavUtil; class NavController extends Controller { use HasAdminQuickCRUD; protected function crud(AdminCRUDBuilder $bhaAK) { goto wYRp7; TcUUM: $bhaAK->scopeDefault(NavPosition::first()); goto fN0tw; fN0tw: $bhaAK->hookSaved(function (Form $mUGak) { $KdsT8 = $mUGak->item(); if ($KdsT8->pid > 0) { $wnQic = ModelUtil::get('nav', $KdsT8->pid); ModelUtil::update('nav', $KdsT8->id, array('position' => $wnQic['position'])); } })->hookChanged(function (Form $mUGak) { NavUtil::clearCache(); })->canBatchDelete(true)->asTree('id', 'pid', 'sort', 'name')->treeMaxLevel(2)->title('导航')->dialogSizeSmall(); goto RJzlO; OwZXr: foreach (NavPosition::getList() as $T_BMM => $Xiug2) { $bhaAK->scopeFilter($T_BMM, $Xiug2, function (ScopeFilter $P2EU9) use($T_BMM) { return $P2EU9->where('position', $T_BMM); }); } goto TcUUM; sE7f2: $bhaAK->init('nav')->field(function ($bhaAK) { $bhaAK->id('id', 'ID'); $bhaAK->select('position', '位置')->optionType(NavPosition::class)->hookRendering(function (AbstractField $sfBE1, $KdsT8, $D01Cg) { switch ($sfBE1->renderMode()) { case FieldRenderMode::DETAIL: case FieldRenderMode::GRID: if ($KdsT8->pid) { return AutoRenderedFieldValue::make(''); } return AutoRenderedFieldValue::make(TypeUtil::name(NavPosition::class, $KdsT8->position)); } }); $bhaAK->text('name', '名称'); $bhaAK->link('link', '链接'); $bhaAK->radio('openType', '打开方式')->optionType(NavOpenType::class)->defaultValue(NavOpenType::CURRENT_WINDOW); $bhaAK->display('created_at', L('Created At'))->listable(false); $bhaAK->display('updated_at', L('Updated At'))->listable(false); }); goto OwZXr; wYRp7: if ($bhaAK->mode() == AdminCRUDBuilder::MODE_FORM) { goto i1wxh; i1wxh: $pseTn = array(); goto NiA2J; NiA2J: foreach (ModelUtil::all('nav', array('pid' => 0), array('*')) as $KdsT8) { $pseTn[$KdsT8['id']] = TypeUtil::name(NavPosition::class, $KdsT8['position']) . ' > ' . $KdsT8['name']; } goto Lk2Yl; bQyUt: ModStart::scriptFile('module/Nav/Admin/Controller/NavEdit.js'); goto oIJjL; Lk2Yl: ModStart::script('window.__navPositionMap=' . json_encode($pseTn) . ';'); goto bQyUt; oIJjL: } goto sE7f2; RJzlO: } }