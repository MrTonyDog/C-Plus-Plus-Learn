<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Vendor\Atomic; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Util\RandomUtil; use ModStart\Core\Util\RedisUtil; class AtomicUtil { public static function produce($Ut_Gf, $Xiug2, $P1cLT = 3600) { if (RedisUtil::isEnable()) { goto iXCJT; rRA15: RedisUtil::expire($UNOF3, $P1cLT); goto sj1Pb; deSPL: RedisUtil::set($UNOF3, $Xiug2); goto rRA15; iXCJT: $UNOF3 = "Atomic:{$Ut_Gf}"; goto deSPL; sj1Pb: } else { if (ModelUtil::exists('atomic', array('name' => $Ut_Gf))) { ModelUtil::update('atomic', array('name' => $Ut_Gf), array('value' => $Xiug2, 'expire' => time() + $P1cLT)); } else { ModelUtil::insert('atomic', array('name' => $Ut_Gf, 'value' => $Xiug2, 'expire' => time() + $P1cLT)); } if (RandomUtil::percent(20)) { ModelUtil::delete('atomic', 'expire', '<', time()); } } } public static function consume($Ut_Gf) { if (RedisUtil::isEnable()) { goto AwWM7; AwWM7: $UNOF3 = "Atomic:{$Ut_Gf}"; goto IsDD7; IsDD7: if (RedisUtil::decr($UNOF3) >= 0) { return true; } goto IHHqc; IHHqc: return false; goto vYN8P; vYN8P: } else { goto a_Rwt; wAuiM: return true; goto UCSig; hzKNw: ModelUtil::transactionCommit(); goto wAuiM; i_x2Z: if ($uKdPy['expire'] < time() || $uKdPy['value'] < 0) { goto AQQAL; yISLo: ModelUtil::transactionCommit(); goto yy4jS; AQQAL: ModelUtil::delete('atomic', array('name' => $Ut_Gf)); goto yISLo; yy4jS: return false; goto KVwBc; KVwBc: } goto CCqm2; CCqm2: ModelUtil::update('atomic', array('name' => $Ut_Gf), array('value' => $uKdPy['value'] - 1)); goto hzKNw; KTU5A: if (empty($uKdPy)) { ModelUtil::transactionCommit(); return false; } goto i_x2Z; a_Rwt: if (RandomUtil::percent(20)) { ModelUtil::delete('atomic', 'expire', '<', time()); } goto mLS1C; mLS1C: ModelUtil::transactionBegin(); goto aOb7I; aOb7I: $uKdPy = ModelUtil::getWithLock('atomic', array('name' => $Ut_Gf)); goto KTU5A; UCSig: } } public static function remove($Ut_Gf) { if (RedisUtil::isEnable()) { $UNOF3 = "Atomic:{$Ut_Gf}"; RedisUtil::delete($UNOF3); } else { ModelUtil::delete('atomic', array('name' => $Ut_Gf)); } } }