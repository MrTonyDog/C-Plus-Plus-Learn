<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Util; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Util\IdUtil; use Module\Member\Type\MemberMoneyCashStatus; use Module\Member\Type\MemberMoneyChargeStatus; class MemberMoneyUtil { public static function paginateLog($H7GUl, $ZcuyS, $iy20Z, $HxhmW = array()) { $HxhmW['where']['memberUserId'] = $H7GUl; return ModelUtil::paginate('member_money_log', $ZcuyS, $iy20Z, $HxhmW); } public static function getTotal($H7GUl) { goto A0S2G; YWVR7: if (empty($avQLM)) { return '0.00'; } goto Q3lyU; Q3lyU: return $avQLM['total']; goto T1neq; A0S2G: $avQLM = ModelUtil::get('member_money', array('memberUserId' => $H7GUl)); goto YWVR7; T1neq: } public static function change($H7GUl, $NublG, $gAM03) { goto nutQI; zJI8T: ModelUtil::insert('member_money_log', array('memberUserId' => $H7GUl, 'change' => $NublG, 'remark' => $gAM03)); goto kAmsv; kAmsv: $avQLM = ModelUtil::update('member_money', array('id' => $avQLM['id']), array('total' => $avQLM['total'] + $NublG)); goto P6aGc; P6aGc: if ($avQLM['total'] < 0) { throw new \Exception('MemberMoneyService -> total empty'); } goto ox9nA; nutQI: if (!$NublG) { throw new \Exception('MemberMoneyService -> change empty'); } goto foHii; foHii: $avQLM = ModelUtil::getWithLock('member_money', array('memberUserId' => $H7GUl)); goto NwiL_; oaklc: if ($NublG < 0 && $avQLM['total'] + $NublG < 0) { throw new \Exception('MemberMoneyService -> total change to empty'); } goto zJI8T; NwiL_: if (empty($avQLM)) { $avQLM = ModelUtil::insert('member_money', array('memberUserId' => $H7GUl, 'total' => 0)); } goto oaklc; ox9nA: } public static function cash($H7GUl, $wb2ee, $NXmo2, $nKLrL, $wQ3sC, $drK7g, $gAM03 = '余额提现') { self::change($H7GUl, -$wb2ee, '余额提现'); ModelUtil::insert('member_money_cash', array('memberUserId' => $H7GUl, 'status' => MemberMoneyCashStatus::VERIFYING, 'money' => $wb2ee, 'moneyAfterTax' => $NXmo2, 'type' => $nKLrL, 'realname' => $wQ3sC, 'account' => $drK7g, 'remark' => $gAM03)); } public static function paginateCash($H7GUl, $ZcuyS, $iy20Z, $HxhmW = array()) { $HxhmW['where']['memberUserId'] = $H7GUl; return ModelUtil::paginate('member_money_cash', $ZcuyS, $iy20Z, $HxhmW); } public static function createCharge($H7GUl, $MR1Ui) { return ModelUtil::insert('member_money_charge', array('sn' => IdUtil::generateSN(), 'status' => MemberMoneyChargeStatus::CREATED, 'memberUserId' => $H7GUl, 'fee' => $MR1Ui)); } public static function processCharge($RdyFT) { goto Il9cd; Il9cd: $R0if5 = ModelUtil::getWithLock('member_money_charge', array('id' => $RdyFT)); goto g8nUM; g8nUM: if (empty($R0if5)) { throw new \Exception('member_money_charge empty -> ' . $RdyFT); } goto KmAQj; dY4Y1: ModelUtil::update('member_money_charge', array('id' => $RdyFT), array('status' => MemberMoneyChargeStatus::SUCCESS)); goto UQp60; rcPzM: self::change($R0if5['memberUserId'], $R0if5['fee'], '充值'); goto dY4Y1; KmAQj: if ($R0if5['status'] != MemberMoneyChargeStatus::CREATED) { throw new \Exception('member_money_charge status error -> ' . $RdyFT); } goto rcPzM; UQp60: } }