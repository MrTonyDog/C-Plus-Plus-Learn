<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\View; use ModStart\App\Web\Layout\WebConfigBuilder; use ModStart\App\Web\Layout\WebPage; use ModStart\Core\Dao\ModelUtil; use ModStart\Core\Exception\BizException; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Core\Util\ArrayUtil; use ModStart\Core\Util\CRUDUtil; use ModStart\Field\AbstractField; use ModStart\Field\AutoRenderedFieldValue; use ModStart\Form\Form; use ModStart\Grid\Grid; use ModStart\Grid\GridFilter; use ModStart\Module\ModuleManager; use ModStart\Repository\Filter\RepositoryFilter; use Module\Member\Auth\MemberUser; use Module\Member\Support\MemberLoginCheck; class MemberAddressController extends MemberFrameController implements MemberLoginCheck { private $api; public function __construct() { parent::__construct(); $this->api = app(\Module\Member\Api\Controller\MemberAddressController::class); } public function index(WebPage $ZcuyS) { goto pxaAw; s9zcw: $fK3QO->useSimple(function (AbstractField $sfBE1, $KdsT8, $D01Cg) { return AutoRenderedFieldValue::makeView('module::Member.View.pc.memberAddress.item', array('item' => $KdsT8)); }); goto oo1Eq; oo1Eq: $fK3QO->title('地址'); goto F5G8r; v31QZ: return $ZcuyS->view($vvDaY)->pageTitle('我的地址')->body($fK3QO); goto indL6; JO1lV: list($vvDaY, $nRAaS) = $this->viewPaths('memberAddress.index'); goto v31QZ; fQmKI: $fK3QO->repositoryFilter(function (RepositoryFilter $P2EU9) { $P2EU9->where(array('memberUserId' => MemberUser::id())); }); goto kX8sO; kX8sO: $fK3QO->disableCUD()->disableItemOperate()->canAdd(true)->urlAdd(action('\\' . __CLASS__ . '@add'))->addDialogSize(array('60%', '80%')); goto s9zcw; pxaAw: $fK3QO = Grid::make('member_address'); goto fQmKI; F5G8r: if (Request::isPost()) { return $fK3QO->request(); } goto JO1lV; indL6: } private function doAddEdit() { goto rNgcj; h4yWB: if (ModuleManager::isModuleEnabled('Area')) { $bhaAK->areaChina('area', '省市地区')->required(); } else { $yQ7gX = '<div class=\'tw-bg-gray-200 tw-rounded tw-px-2\'>省市地区需要依赖 <a href=\'https://modstart.com/m/Area\' target=\'_blank\'>Area</a> 模块</div>'; $bhaAK->html('area', '省市地区')->html($yQ7gX)->addable(true)->required(); } goto YV6AP; tCTvV: $bhaAK->pageTitle(($DRfwW ? '修改' : '增加') . '地址'); goto enjYa; enjYa: $bhaAK->text('name', '姓名')->required(); goto NGT7D; Wsl6c: return $bhaAK->perform(ArrayUtil::keepKeys($Nfq8P, array('name', 'phone', 'area', 'detail', 'post')), function (Form $mUGak) use($DRfwW) { $hRWBB = $mUGak->dataForming(); if ($DRfwW) { ModelUtil::update('member_address', $DRfwW, $hRWBB); } else { $hRWBB['memberUserId'] = MemberUser::id(); ModelUtil::insert('member_address', $hRWBB); } return Response::redirect(CRUDUtil::jsDialogCloseAndParentGridRefresh()); }); goto Y2qob; FBkpc: $Nfq8P = null; goto Yy2vb; Newrb: $bhaAK->useDialog(); goto tCTvV; Ow1s2: $bhaAK->text('post', '邮政编码'); goto Wsl6c; NGT7D: $bhaAK->text('phone', '手机号')->required(); goto h4yWB; rNgcj: $DRfwW = CRUDUtil::id(); goto FBkpc; JWl_z: $bhaAK = app(WebConfigBuilder::class); goto Newrb; YV6AP: $bhaAK->textarea('detail', '详细地址')->required(); goto Ow1s2; Yy2vb: if ($DRfwW) { $Nfq8P = ModelUtil::get('member_address', array('id' => $DRfwW, 'memberUserId' => MemberUser::id())); BizException::throwsIfEmpty('地址不存在', $Nfq8P); } goto JWl_z; Y2qob: } public function add() { return $this->doAddEdit(); } public function edit() { return $this->doAddEdit(); } public function delete() { goto lXRQ8; jvJNz: BizException::throwsIfEmpty('地址不存在', $Nfq8P); goto HSJ3y; AovIG: $Nfq8P = ModelUtil::get('member_address', array('id' => $DRfwW, 'memberUserId' => MemberUser::id())); goto jvJNz; lXRQ8: $DRfwW = CRUDUtil::id(); goto AovIG; HSJ3y: ModelUtil::delete('member_address', $DRfwW); goto Hx0F1; Hx0F1: return Response::redirect(CRUDUtil::jsGridRefresh()); goto MhXgH; MhXgH: } }