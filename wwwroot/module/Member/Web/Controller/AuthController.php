<?php
/**
 * ------------------------ 
 *  版权所有  www.tecmz.com
 *  商业版本请购买正版授权使用
 * ------------------------
*/ namespace Module\Member\Web\Controller; use Illuminate\Support\Facades\Input; use Illuminate\Support\Facades\Session; use ModStart\Core\Input\InputPackage; use ModStart\Core\Input\Request; use ModStart\Core\Input\Response; use ModStart\Module\ModuleBaseController; use Module\Member\Auth\MemberUser; class AuthController extends ModuleBaseController { private $api; public function __construct() { $this->api = app(\Module\Member\Api\Controller\AuthController::class); } public function login() { goto u46Wv; u46Wv: $HoLMG = InputPackage::buildFromInput(); goto UNq7v; tVGUq: if (Request::isPost()) { goto B6hgx; B6hgx: $mW7Vi = $this->api->login(); goto uVubm; uVubm: if (Response::isError($mW7Vi)) { return Response::sendFromGenerate($mW7Vi); } goto RgYia; RgYia: return Response::send(0, '', '', $vB6nX); goto Bxr_C; Bxr_C: } goto P0hXo; BtEg0: if (modstart_config('ssoClientEnable', false)) { goto rUPMl; fQ89T: $mW7Vi = $this->api->ssoClientPrepare(); goto T14jz; Cw_dn: Session::put('ssoClientRedirect', $vB6nX); goto DzHtt; DzHtt: return Response::send(0, null, null, $mW7Vi['data']['redirect']); goto HQVYP; rUPMl: Input::merge(array('client' => Request::domainUrl() . '/sso/client')); goto fQ89T; T14jz: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto Cw_dn; HQVYP: } goto tVGUq; UNq7v: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto BtEg0; P0hXo: return $this->view('login', array('redirect' => $vB6nX)); goto TYkTm; TYkTm: } public function loginCaptcha() { return $this->api->loginCaptchaRaw(); } public function logout() { goto lQ0Y6; UqV4v: $HoLMG = InputPackage::buildFromInput(); goto O9g41; lQ0Y6: $HoLMG = InputPackage::buildFromInput(); goto UU2DY; UU2DY: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto VvDtR; O9g41: Session::forget('memberUserId'); goto okwZK; okwZK: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto ujGQV; HRfxJ: $mW7Vi = $this->api->logout(); goto df_Ab; df_Ab: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto UqV4v; ujGQV: return Response::redirect($vB6nX); goto Bepe7; VvDtR: if (modstart_config('ssoClientEnable', false) && modstart_config('ssoClientLogoutSyncEnable', false)) { goto oJCEf; t6WS_: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto f5nfk; J8Rh1: $mW7Vi = $this->api->ssoClientLogoutPrepare(); goto t6WS_; tvGQo: return Response::send(0, null, null, $mW7Vi['data']['redirect']); goto PWtqE; oJCEf: Input::merge(array('domainUrl' => Request::domainUrl())); goto J8Rh1; f5nfk: Session::put('ssoLogoutRedirect', $vB6nX); goto tvGQo; PWtqE: } goto HRfxJ; Bepe7: } public function register() { goto a9oCG; a9oCG: $HoLMG = InputPackage::buildFromInput(); goto WeDFP; whSnP: return $this->view('register', array('redirect' => $vB6nX)); goto X6hGy; WeDFP: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto hM1bn; hM1bn: if (Request::isPost()) { goto TcGSo; LYViX: return Response::send(0, '', '', modstart_web_url('login') . '?redirect=' . urlencode($vB6nX)); goto Zt12b; QZKq3: if ($mW7Vi['code']) { if ($HoLMG->getTrimString('captcha')) { return Response::send(-1, $mW7Vi['msg'], null, '[js]$("[data-captcha]").click()'); } return Response::send(-1, $mW7Vi['msg']); } goto LYViX; TcGSo: $mW7Vi = $this->api->register(); goto QZKq3; Zt12b: } goto whSnP; X6hGy: } public function registerEmailVerify() { return Response::sendFromGenerate($this->api->registerEmailVerify()); } public function registerPhoneVerify() { return Response::sendFromGenerate($this->api->registerPhoneVerify()); } public function registerCaptcha() { return $this->api->registerCaptchaRaw(); } public function registerCaptchaVerify() { goto coXHw; Rn0iE: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg'], null, '[js]$("[data-captcha]").click()'); } goto h938S; coXHw: $mW7Vi = $this->api->registerCaptchaVerify(); goto Rn0iE; h938S: return Response::send(0, $mW7Vi['msg']); goto u0vzP; u0vzP: } public function retrieve() { goto RGKxg; lCnmb: return $this->view('retrieve', array('redirect' => $vB6nX)); goto PgTtq; RGKxg: $HoLMG = InputPackage::buildFromInput(); goto vldv0; vldv0: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto lCnmb; PgTtq: } public function retrievePhone() { goto b2GRE; p21UI: if (Request::isPost()) { goto g7LBD; g7LBD: $mW7Vi = $this->api->retrievePhone(); goto ZdCGa; ZdCGa: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto onl4u; onl4u: return Response::send(0, $mW7Vi['msg'], null, modstart_web_url('retrieve') . '/reset?redirect=' . urlencode($vB6nX)); goto WGENv; WGENv: } goto ub2Z4; M2pBw: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto p21UI; ub2Z4: return $this->view('retrievePhone', array('redirect' => $vB6nX)); goto b5waf; b2GRE: $HoLMG = InputPackage::buildFromInput(); goto M2pBw; b5waf: } public function retrievePhoneVerify() { return Response::sendFromGenerate($this->api->retrievePhoneVerify()); } public function retrieveEmail() { goto lJS8N; D4GaX: if (Request::isPost()) { goto cCujG; cCujG: $mW7Vi = $this->api->retrieveEmail(); goto ZRnXr; ZQm00: return Response::send(0, $mW7Vi['msg'], null, modstart_web_url('retrieve') . '/reset?redirect=' . urlencode($vB6nX)); goto EqB5t; ZRnXr: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto ZQm00; EqB5t: } goto PZLOt; PZLOt: return $this->view('retrieveEmail', array('redirect' => $vB6nX)); goto xSFuL; XyFxK: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto D4GaX; lJS8N: $HoLMG = InputPackage::buildFromInput(); goto XyFxK; xSFuL: } public function retrieveEmailVerify() { return Response::sendFromGenerate($this->api->retrieveEmailVerify()); } public function retrieveCaptcha() { return $this->api->retrieveCaptchaRaw(); } public function retrieveReset() { goto BoplF; i0R5D: return $this->view('retrieveReset', array('redirect' => $vB6nX, 'memberUser' => $mW7Vi['data']['memberUser'])); goto ssw0Y; jSoie: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto i0R5D; gj1Dv: if (Request::isPost()) { goto IJlSP; IJlSP: $mW7Vi = $this->api->retrieveReset(); goto ATtXh; OiAtm: return Response::send(0, $mW7Vi['msg'], null, $vB6nX); goto LtTUM; ATtXh: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto OiAtm; LtTUM: } goto I2DOK; BoplF: $HoLMG = InputPackage::buildFromInput(); goto qjR7I; I2DOK: $mW7Vi = $this->api->retrieveResetInfo(); goto jSoie; qjR7I: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto gj1Dv; ssw0Y: } public function oauthLogin($LYyd5 = null) { goto S5enk; J0Vhh: $vvDaY = $HoLMG->getBoolean('view', false); goto hUHLJ; XpjVU: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto Tb7iz; IEwP3: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto AWm0r; W4t5s: $mW7Vi = $this->api->oauthLogin($LYyd5, $KEWDy); goto IEwP3; Tb7iz: $KEWDy = Request::domainUrl() . '/oauth_callback_' . $LYyd5; goto W4t5s; S5enk: $HoLMG = InputPackage::buildFromInput(); goto J0Vhh; hUHLJ: if ($vvDaY) { Session::put('oauthLoginView', true); } goto XpjVU; KYVF8: return Response::redirect($mW7Vi['data']['redirect']); goto Bp0Uu; AWm0r: Session::put('oauthRedirect', $vB6nX); goto KYVF8; Bp0Uu: } public function oauthCallback($LYyd5 = null) { goto yogx0; Aingv: $mW7Vi = $this->api->oauthCallback($LYyd5, $KEWDy); goto gfyd0; Efe3v: $vvDaY = Session::get('oauthLoginView', false); goto dVNpH; N8JTg: if ($vvDaY) { goto Qag4v; BZajz: return Response::redirect($vB6nX); goto Tzesg; BELti: $jQCZu = Session::get('oauthUserInfo'); goto HUq5n; Qag4v: $vB6nX = Session::get('oauthRedirect', modstart_web_url('')); goto BELti; HUq5n: Session::put('oauthViewOpenId_' . $LYyd5, $jQCZu['openid']); goto BZajz; Tzesg: } goto w17Od; yogx0: $KEWDy = Request::domainUrl() . '/oauth_callback_' . $LYyd5; goto Aingv; gfyd0: if ($mW7Vi['code']) { return Response::sendFromGenerate($mW7Vi); } goto Efe3v; dVNpH: Session::forget('oauthLoginView'); goto N8JTg; w17Od: return Response::redirect(Request::domainUrl() . '/oauth_bind_' . $LYyd5); goto HSL7p; HSL7p: } public function oauthBind($LYyd5 = null) { goto nWBvH; nWBvH: $vB6nX = Session::get('oauthRedirect', modstart_web_url('')); goto grwaC; A8pzL: if (MemberUser::isLogin()) { goto G2RJ2; pB7oq: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto oC0BF; oC0BF: Session::forget('oauthRedirect'); goto J6ToG; J6ToG: return Response::send(0, '绑定成功', null, $vB6nX); goto VY3xj; G2RJ2: $mW7Vi = $this->api->oauthBind($LYyd5); goto pB7oq; VY3xj: } goto Fn_s7; BWV2t: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto u_NMr; grwaC: if (Request::isPost()) { goto wDDqj; UAW0u: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto G81Ji; ZMxDQ: return Response::send(0, $mW7Vi['msg'], null, $vB6nX); goto O7ZSG; wDDqj: $mW7Vi = $this->api->oauthBind($LYyd5); goto UAW0u; G81Ji: Session::forget('oauthRedirect'); goto ZMxDQ; O7ZSG: } goto v1lAN; v1lAN: $jQCZu = Session::get('oauthUserInfo', array()); goto obuwc; obuwc: $mW7Vi = $this->api->oauthTryLogin($LYyd5); goto BWV2t; Fn_s7: return $this->view('oauthBind', array('oauthUserInfo' => $jQCZu, 'redirect' => $vB6nX)); goto tO93q; u_NMr: if ($mW7Vi['data']['memberUserId'] > 0) { Session::forget('oauthRedirect'); return Response::redirect($vB6nX); } goto A8pzL; tO93q: } public function oauthProxy() { return $this->view('oauthProxy'); } public function ssoClient() { goto t8hlT; t8hlT: $mW7Vi = $this->api->ssoClient(); goto lP2t1; Hd8nD: $vB6nX = Session::get('ssoClientRedirect', modstart_web_url('')); goto qQa4m; qQa4m: return Response::send(0, null, null, $vB6nX); goto xSuOK; lP2t1: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto Hd8nD; xSuOK: } public function ssoServer() { goto ZLWzB; ATPtN: return Response::send(0, null, null, modstart_web_url('login') . '?' . http_build_query(array('redirect' => $GpA13))); goto jFXK_; ONDFn: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto UADAs; sbYvk: if ($mW7Vi['data']['isLogin']) { return Response::send(0, null, null, $GpA13); } goto ATPtN; UADAs: $GpA13 = '/sso/server_success?' . http_build_query(array('client' => $HoLMG->getTrimString('client'), 'domainUrl' => Request::domainUrl())); goto sbYvk; ZLWzB: $HoLMG = InputPackage::buildFromInput(); goto i0w2I; i0w2I: $mW7Vi = $this->api->ssoServer(); goto ONDFn; jFXK_: } public function ssoServerSuccess() { goto tlJt1; tlJt1: $mW7Vi = $this->api->ssoServerSuccess(); goto dXLC6; dXLC6: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto chd8R; chd8R: return Response::send(0, null, null, $mW7Vi['data']['redirect']); goto KbHw9; KbHw9: } public function ssoServerLogout() { goto lArfV; Mqv2T: $mW7Vi = $this->api->ssoServerLogout(); goto K1Lc4; hLSBP: $vB6nX = $HoLMG->getTrimString('redirect', modstart_web_url('')); goto mIy0l; mIy0l: return Response::send(0, null, null, $vB6nX); goto MrqBf; lArfV: $HoLMG = InputPackage::buildFromInput(); goto Mqv2T; K1Lc4: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto hLSBP; MrqBf: } public function ssoClientLogout() { goto uz7RV; OjNdq: if ($mW7Vi['code']) { return Response::send(-1, $mW7Vi['msg']); } goto brZsd; brZsd: $vB6nX = Session::get('ssoLogoutRedirect', modstart_web_url('')); goto OPBbB; uz7RV: $mW7Vi = $this->api->ssoClientLogout(); goto OjNdq; OPBbB: return Response::send(0, null, null, $vB6nX); goto WBdhB; WBdhB: } }